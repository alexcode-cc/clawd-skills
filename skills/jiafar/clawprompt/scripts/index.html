<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClawPrompt ğŸ¦ğŸ“ æ™ºèƒ½æè¯å™¨</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'PingFang SC','Hiragino Sans GB',sans-serif;background:#000;color:#eee;min-height:100vh;overflow:hidden}

/* === Setup Screen === */
.setup{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:24px;padding:20px}
.setup.hidden{display:none}
.setup h1{font-size:28px;font-weight:300;letter-spacing:2px}
.setup h1 span{color:#4ecdc4}
.setup textarea{width:min(600px,90vw);height:180px;background:#111;border:1px solid #333;border-radius:12px;padding:16px;font-size:16px;color:#eee;resize:vertical;line-height:1.8}
.setup textarea:focus{outline:none;border-color:#4ecdc4}
.setup textarea::placeholder{color:#555}
.btn{padding:12px 40px;border:none;border-radius:8px;font-size:18px;cursor:pointer;transition:all .2s}
.btn-start{background:#4ecdc4;color:#000;font-weight:600}
.btn-start:hover{background:#45b7aa;transform:scale(1.03)}
.btn-start:disabled{opacity:.4;cursor:default;transform:none}
.qr-area{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:8px}
.qr-area canvas{border-radius:8px}
.qr-label{color:#666;font-size:13px}
.qr-url{color:#4ecdc4;font-size:12px;word-break:break-all}
.status-bar{color:#555;font-size:12px}
.status-bar .dot{display:inline-block;width:8px;height:8px;border-radius:50%;vertical-align:middle;margin-right:4px}
.dot.on{background:#4ecdc4}.dot.off{background:#555}
.hint{color:#444;font-size:13px;text-align:center;line-height:1.8}

/* === Teleprompter Fullscreen === */
.teleprompter{display:none;position:fixed;inset:0;background:#000;z-index:9999;flex-direction:column;align-items:center;cursor:default;user-select:none}
.teleprompter.active{display:flex}
.tp-text{margin-top:5vh;width:45%;text-align:center}
.tp-text .line{display:block;line-height:1.5;transition:color .2s}
.tp-text .line.current{color:#fff}
.tp-text .line.next{color:#555}
.tp-bottom{position:fixed;bottom:0;left:0;right:0;display:flex;flex-direction:column;align-items:center;gap:8px;padding-bottom:20px}
.tp-qr{opacity:.3;transition:opacity .2s}
.tp-qr:hover{opacity:.8}
.tp-progress{color:#333;font-size:13px}
.tp-hint{color:#222;font-size:11px}

/* === Countdown === */
.countdown{display:none;position:fixed;inset:0;background:#000;z-index:10000;justify-content:center;align-items:center;font-size:120px;color:#4ecdc4;font-weight:200}
.countdown.active{display:flex}
</style>
</head>
<body>

<div class="setup" id="setup">
  <h1>ğŸ¬ <span>ClawPrompt</span></h1>
  <textarea id="input" placeholder="åœ¨æ­¤ç²˜è´´ä½ çš„æ–‡æ¡ˆ...&#10;æ”¯æŒä¸­è‹±æ–‡ï¼Œè‡ªåŠ¨æŒ‰æ ‡ç‚¹åˆ†å¥&#10;&#10;æ‰‹æœºç«¯ä¹Ÿå¯ä»¥ä¸Šä¼ æ–‡æ¡ˆ"></textarea>
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center">
    <button class="btn btn-start" id="startBtn" disabled>å¼€å§‹æè¯</button>
    <span class="status-bar" id="statusBar"><span class="dot off"></span>ç­‰å¾…æ‰‹æœºè¿æ¥</span>
  </div>
  <div class="qr-area" id="qrArea">
    <img id="qrImg" style="width:160px;height:160px;border-radius:8px;background:#fff">
    <div class="qr-label">ğŸ“± æ‰‹æœºæ‰«ç  â†’ å˜èº«é¥æ§å™¨</div>
    <div class="qr-url" id="qrUrl"></div>
  </div>
  <div class="hint">
    å…¨å±å¿«æ·é”®ï¼šç©ºæ ¼/â†“ ä¸‹ä¸€å¥ Â· â†‘ ä¸Šä¸€å¥ Â· +/- è°ƒå­—å· Â· ESC é€€å‡º
  </div>
</div>

<div class="teleprompter" id="tp">
  <div class="tp-text" id="tpText"></div>
  <div class="tp-bottom">
    <img class="tp-qr" id="tpQr" style="width:100px;height:100px;border-radius:6px" title="æ‰‹æœºæ‰«ç é¥æ§">
    <div class="tp-progress" id="tpProgress"></div>
    <div class="tp-hint">ç©ºæ ¼/â†“ ä¸‹ä¸€å¥ Â· â†‘ ä¸Šä¸€å¥ Â· +/- å­—å· Â· ESC é€€å‡º</div>
  </div>
</div>

<div class="countdown" id="countdown"></div>

<!-- No external QR lib needed -->

<script>
const $ = s => document.getElementById(s);
const input = $('input'), startBtn = $('startBtn');
const tp = $('tp'), tpText = $('tpText'), tpProgress = $('tpProgress');
const cdEl = $('countdown'), statusBar = $('statusBar');

let sentences = [], idx = 0, fontSize = 44;
let ws, remoteCount = 0;

// Load saved text
const saved = localStorage.getItem('tp_text');
if (saved) { input.value = saved; parseSentences(); }

input.addEventListener('input', () => {
  localStorage.setItem('tp_text', input.value);
  parseSentences();
  syncText();
});

function parseSentences() {
  const raw = input.value.trim();
  if (!raw) { sentences = []; startBtn.disabled = true; return; }
  sentences = raw.split(/(?<=[ã€‚ï¼Ÿï¼ï¼Œ,.!?ï¼›;ã€\n])/g).map(s => s.trim()).filter(s => s.length > 0);
  startBtn.disabled = sentences.length === 0;
}

function esc(s) { return s.replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// === QR Code (server-generated) ===
function renderQR() {
  fetch('/qr-url').then(r => r.json()).then(data => {
    const url = data.url;
    $('qrUrl').textContent = url;
    $('qrImg').src = `/qr.png?url=${encodeURIComponent(url)}&size=160`;
    $('tpQr').src = `/qr.png?url=${encodeURIComponent(url)}&size=100`;
  }).catch(() => {
    // Fallback: use current host
    const url = `${location.protocol}//${location.host}/remote`;
    $('qrUrl').textContent = url;
    $('qrImg').src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(url)}`;
    $('tpQr').src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(url)}`;
  });
}

// === WebSocket ===
function wsConnect() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}`);
  ws.onopen = () => syncState();
  ws.onclose = () => setTimeout(wsConnect, 2000);
  ws.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'cmd') {
        if (msg.action === 'next') doNext();
        else if (msg.action === 'prev') doPrev();
      } else if (msg.type === 'text') {
        // Remote uploaded text
        input.value = msg.text;
        localStorage.setItem('tp_text', msg.text);
        parseSentences();
        idx = 0;
        if (tp.classList.contains('active')) renderTp();
      } else if (msg.type === 'remoteCount') {
        remoteCount = msg.count;
        updateStatus();
      }
    } catch {}
  };
}

function updateStatus() {
  if (remoteCount > 0) {
    statusBar.innerHTML = `<span class="dot on"></span>${remoteCount} å°æ‰‹æœºå·²è¿æ¥`;
  } else {
    statusBar.innerHTML = `<span class="dot off"></span>ç­‰å¾…æ‰‹æœºè¿æ¥`;
  }
}

function syncState() {
  if (!ws || ws.readyState !== 1) return;
  ws.send(JSON.stringify({
    type: 'sync', idx, total: sentences.length,
    current: sentences[idx] || '', next: sentences[idx + 1] || ''
  }));
}

function syncText() {
  if (!ws || ws.readyState !== 1) return;
  ws.send(JSON.stringify({ type: 'fulltext', text: input.value }));
}

// === Teleprompter ===
startBtn.addEventListener('click', startTeleprompter);

function startTeleprompter() {
  idx = 0;
  document.documentElement.requestFullscreen?.() || document.documentElement.webkitRequestFullscreen?.();
  cdEl.classList.add('active');
  let c = 3;
  cdEl.textContent = c;
  const ci = setInterval(() => {
    c--;
    if (c > 0) { cdEl.textContent = c; }
    else { clearInterval(ci); cdEl.classList.remove('active'); showTp(); }
  }, 800);
}

function showTp() {
  tp.classList.add('active');
  $('setup').classList.add('hidden');
  renderTp();
}

function renderTp() {
  const cur = sentences[idx] || '';
  const nxt = sentences[idx + 1] || '';
  tpText.innerHTML = `<span class="line current">${esc(cur)}</span>${nxt ? '<br><span class="line next">' + esc(nxt) + '</span>' : ''}`;
  tpText.style.fontSize = fontSize + 'px';
  tpProgress.textContent = sentences.length ? `${idx + 1} / ${sentences.length}` : '';
  syncState();
}

function doNext() { if (idx < sentences.length - 1) { idx++; renderTp(); } }
function doPrev() { if (idx > 0) { idx--; renderTp(); } }
function exitTp() {
  tp.classList.remove('active');
  $('setup').classList.remove('hidden');
  (document.exitFullscreen || document.webkitExitFullscreen)?.call(document);
}

// Keyboard
document.addEventListener('keydown', e => {
  if (!tp.classList.contains('active')) return;
  if (e.code === 'Space' || e.code === 'ArrowDown') { e.preventDefault(); doNext(); }
  else if (e.code === 'ArrowUp') { e.preventDefault(); doPrev(); }
  else if (e.code === 'Escape') { e.preventDefault(); exitTp(); }
  else if (e.key === '=' || e.key === '+') { fontSize = Math.min(80, fontSize + 4); renderTp(); }
  else if (e.key === '-') { fontSize = Math.max(20, fontSize - 4); renderTp(); }
});

// Init
if (location.protocol !== 'file:') {
  wsConnect();
  renderQR();
}
</script>
</body>
</html>
