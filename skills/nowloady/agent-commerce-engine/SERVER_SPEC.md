# Server-Side Implementation Specification (Agent-Native API)

This document defines the standard API responses and behaviors required for a website backend to be fully compatible with the **Standard Agentic Commerce Engine**.

By following this specification, any e-commerce backend (Next.js, Python/Django, Go, Node.js etc.) can be autonomously navigated and operated by AI Agents using the `commerce.py` client.

---

## ðŸš€ Quick Start: Building a Compatible Backend (Python/FastAPI Example)

To make your website "Agent-Ready" instantly, you just need to implement a few REST endpoints that return standard JSON.

Here is a minimum viable Example using **FastAPI** (Python):

```python
from fastapi import FastAPI, Header, HTTPException
from typing import Optional

app = FastAPI()

# 1. Product Discovery
@app.get("/products")
async def list_products(q: Optional[str] = None):
    # If q is provided, search products, otherwise return all
    return {
        "success": True,
        "total": 1,
        "products": [
            {
                "slug": "premium-coffee-beans",
                "name": "Ethiopian Yirgacheffe",
                "description": "Light roast with floral notes.",
                "category": "coffee",
                "variants": [
                    {"variant": "250g", "price": 18.00},
                    {"variant": "500g", "price": 32.00, "label": "Best Value"}
                ]
            }
        ]
    }

# 2. Add to Cart
@app.post("/cart")
async def add_to_cart(
    payload: dict,
    x_visitor_id: Optional[str] = Header(None),
    x_api_token: Optional[str] = Header(None)
):
    product_slug = payload.get("product_slug")
    variant = payload.get("variant")
    quantity = payload.get("quantity", 1)
    
    # Store in database using x_visitor_id (guest) or x_api_token (logged in)
    return {"success": True, "message": f"Added {quantity}x {variant} of {product_slug}"}

# 3. View Cart
@app.get("/cart")
async def view_cart(x_visitor_id: Optional[str] = Header(None)):
    return {
        "success": True,
        "totalPrice": 18.00,
        "items": [
            {"product_slug": "premium-coffee-beans", "variant": "250g", "quantity": 1, "price": 18.00}
        ]
    }

# Run with: uvicorn main:app --port 8000
# Then agents can connect via COMMERCE_URL="http://localhost:8000"
```

---

## 1. General Principles

- **Stateless Authentication**: Agents operate without cookies. Rely on Custom Headers (`x-user-account`, `x-api-token`).
- **AI-Friendly Errors**: Use descriptive `instruction` fields in error responses to guide the Agent's next action.
- **Stable Slugs & Variants**: Use permanent human-readable strings (e.g., `slug: spicy-rabbit`, `variant: XL-Red`) as primary identifiers rather than volatile abstract numeric IDs.

---

## 2. Global Headers & Auth

### Custom Headers
- `x-visitor-id`: A unique UUID generated by the client to track guest carts.
- `x-api-token`: The secure authentication token (Preferred).
- `x-user-account`: User's login identifier (email/phone).
- `x-user-password`: User's password (Only used during `/auth/token` exchange).

### Authentication Flow (Stateless)
1. **Agent Logs In**: `POST /auth/token` with account/password. Return a token.
2. **Missing Token**: If an endpoint requires auth and token is missing, return `401 Unauthorized`:
   ```json
   { "error": "Authentication Required", "instruction": "Ask user to login." }
   ```
3. **Invalid User**: Return `404 Not Found`.
   ```json
   { "error": "User Not Found", "register_url": "https://yoursite.com/register" }
   ```

---

## 3. API Endpoints Reference

### A. Product Discovery
`GET /products` | `GET /products/{slug}`
- **Params**: `q` (search query), `category` (filter).
- **Required Model Attributes**:
  - `slug`: String
  - `name`: String
  - `variants` (or array of objects): Must contain a `variant` key (String or Number) and `price` (Number). *(Note: Legacy `gram` is also supported for backward compatibility)*

### B. Brand Information
`GET /brand?category=<type>`
- **Types**: `story`, `company`, `contact`.

### C. Shopping Cart
`GET /cart` | `POST /cart` | `PUT /cart` | `DELETE /cart`
- **Request Body**: `{ "product_slug": string, "variant": string/number, "quantity": number }`. 
- **Response**: Return the full cart snapshot including `totalPrice` and `items`.

### D. User Profile
`GET /user/profile` | `PUT /user/profile`
- **Schema**: Should support common fields like `name`, `address`, and `phone`.

### E. Checkout & Payment Handoff
`POST /orders` | `GET /orders`
- **Request Body (POST)**: `{ "shipping": { "name": "...", "phone": "...", "province": "...", "city": "...", "address": "..." } }`
- **Behavior (POST)**: Transforms the current cart (identified securely by Token or Visitor ID) into a formal Order. Must clear the active cart upon success and return an `<ORDER_ID>`.
- **Payment Limitation (Crucial)**: Automated agents currently cannot complete interactive consumer payments (like credit card 3D Secure, Apple Pay, WeChat Pay). Wait for the API to return a payment link or an order dashboard URL (e.g. `https://yourstore.com/orders/<ORDER_ID>`). The Agent must deliver this final URL to the human to complete checkout.

---

## 4. Best Practices for "Agent-Friendliness"

1. **Provide Metadata**: Include VIP prices, promotion flags, or tags in the product list so the Agent can advocate for value and persuade the user.
2. **Handle Typos Gracefully**: If an Agent requests a category that doesn't exist, return a list of `available_categories` within the error message.
3. **Instruction Injection**:
   - Instead of a blunt "403 Forbidden", use:
     `{ "error": "Action Denied", "instruction": "This product is only available for VIP members. Suggest the user to upgrade." }`

---

## 5. Live Examples
- **Lafeitu API Demo (Node.js/Next.js)**: [Check the /api/v1 handlers](https://github.com/NowLoadY/lafeitu_official/tree/main/next-app/pages/api/v1).
